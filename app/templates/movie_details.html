{% extends "base.html" %}
{% block title %}{{ movie.title }}{% endblock %}

{% block content %}
    <article class="movie-detail container mb-5">
        
        <div class="main-header-flex d-flex justify-content-between align-items-center mb-4 pb-2">
            
            <div class="title-and-year-group d-flex align-items-end">
                <h2 class="movie-title-detail mb-0">{{ movie.title }}</h2>
                <p class="movie-year mb-0 ms-3">({{ movie.release_year }})</p>
            </div>
            
            <div class="rating-badges-group d-flex align-items-center gap-3">
                
                {% if movie.imdb_rating %}
                    <div class="critic-rating-badge text-dark">
                        <i class="fas fa-star-half-alt"></i> 
                        <strong>Critic:</strong> {{ movie.imdb_rating }}
                    </div>
                {% endif %}
            </div>
        </div>

        <hr class="header-divider">

        <div class="row mt-4">
            
            <div class="col-md-4">
                {% if movie.poster_url %}
                    <img src="{{ movie.poster_url }}" alt="Poster {{ movie.title }}" class="img-fluid rounded shadow poster-image detail-poster">
                {% else %}
                    <div class="placeholder-poster p-5 bg-secondary text-white rounded text-center detail-poster">
                        <i class="fas fa-image fa-3x"></i>
                        <p class="mt-2">No Image</p>
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-8 movie-details-content">
                
                <p class="movie-description-detail">{{ movie.description }}</p>
                {% if avg_rating is not none %}
                    <div class="avg-rating-global-badge">
                        Global Rating: <strong>{{ "%.1f" | format(avg_rating) }} / 10</strong>
                    </div>
                {% endif %}
                {% if current_user.is_authenticated %}
                    
                    <div class="user-actions-panel mb-4">
                        
                        <div class="d-flex justify-content-between align-items-center gap-3 movie-actions-row">
                            
                            {# 1. BUTON WATCHLIST (Stânga) #}
                            <form method="POST" action="{{ url_for('toggle_watchlist', movie_id=movie.id) }}" class="flex-grow-1">
                                <button type="submit" 
                                        class="btn btn-lg w-100 text-dark btn-action-red {% if is_in_watchlist %}btn-action-checked{% else %}btn-action-primary{% endif %}">
                                    <div class="d-flex justify-content-center align-items-center">
                                        <span>
                                            {% if is_in_watchlist %}
                                                <i class="fas fa-check"></i> În Watchlist
                                            {% else %}
                                                <i class="fas fa-plus"></i> Adaugă în Watchlist
                                            {% endif %}
                                        </span>
                                    </div>
                                </button>
                            </form>

                            {# 2. BUTON FILME VĂZUTE (Dreapta) #}
                            <form method="POST" action="{{ url_for('toggle_seen', movie_id=movie.id) }}" class="flex-grow-1">
                                <button type="submit" 
                                        class="btn btn-lg w-100 btn-action-secondary {% if is_seen %}btn-action-seen{% else %}btn-action-default{% endif %}">
                                    <i class="fas fa-eye"></i> 
                                    {% if is_seen %}
                                        Scoatere de la Văzute
                                    {% else %}
                                        Marcare ca Văzut
                                    {% endif %}
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    {# 3. SECȚIUNE RATING #}
                    <div id="ratingSection" class="rating-box mt-4 p-3 w-100">
                         <h3 class="section-title-small">Rate Movie</h3>

                        <form method="POST" action="{{ url_for('rate_movie', movie_id=movie.id) }}" id="ratingForm" class="w-100 d-flex flex-column align-items-center">
                            <label for="score" class="form-label d-flex justify-content-center align-items-center mb-4">
                                Rating-ul tău: 
                                <span id="dynamicScoreDisplay" class="ms-3 current-hover-score">
                                    {{ user_rating or 0 }}/10
                                </span>
                            </label>
                            
                            <div class="star-rating mb-3" data-current-score="{{ user_rating or 0 }}">
                                {% for i in range(1, 11) %}
                                    <span class="star" data-score="{{ i }}">
                                        <i class="fas fa-star"></i>
                                    </span>
                                {% endfor %}
                            </div>

                            <input type="hidden" name="score" id="scoreInput" value="{{ user_rating or 0 }}" required>

                            <button type="submit" class="btn btn-primary btn-rating w-100">
                                {{ 'Actualizează' if user_rating else 'Trimite Rating' }} 
                            </button>
                        </form>
                        
                        {% if user_rating %}
                            <p class="current-rating mt-2">Evaluarea ta curentă: <strong>{{ user_rating }}/10</strong></p>
                        {% elif is_seen %}
                            <p class="current-rating mt-2 text-muted">Marchezi filmul ca văzut, dar nu ai oferit rating.</p>
                        {% endif %}
                    </div>

                {% else %}
                    <p class="alert alert-warning">Vă rugăm să vă autentificați pentru a adăuga filme în liste și pentru a oferi rating-uri.</p>
                {% endif %}
            </div>
        </div>
    </article>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const starRatingContainer = document.querySelector('.star-rating');
            const stars = starRatingContainer ? starRatingContainer.querySelectorAll('.star') : [];
            const scoreInput = document.getElementById('scoreInput');
            const dynamicScoreDisplay = document.getElementById('dynamicScoreDisplay'); // NOU: Scorul dinamic
            
            // Scorul inițial (din baza de date)
            const initialScore = parseInt(starRatingContainer.dataset.currentScore) || 0;

            // Funcție pentru a actualiza vizualizarea scorului (steluțe și text)
            function updateScoreVisual(score, isHover) {
                // 1. Steluțele mici
                stars.forEach(star => {
                    const starScore = parseInt(star.dataset.score);
                    // Dacă scorul este mai mare, aplicăm clasa
                    if (starScore <= score) {
                        star.classList.add(isHover ? 'hovered' : 'selected');
                        star.classList.remove(isHover ? 'selected' : 'hovered');
                    } else {
                        star.classList.remove('selected', 'hovered');
                    }
                });
                
                // 2. Afișajul scorului dinamic
                if (dynamicScoreDisplay) {
                    dynamicScoreDisplay.textContent = `${score}/10`;
                }
            }

            // Funcție pentru a reseta vizualizarea la scorul selectat
            function resetVisualToSelected() {
                stars.forEach(star => star.classList.remove('hovered'));
                const currentSelectedScore = parseInt(scoreInput.value) || 0;
                updateScoreVisual(currentSelectedScore, false);
            }
            
            // Inițializează starea vizuală la încărcare
            updateScoreVisual(initialScore, false);

            // 1. Logica la Click (Setează scorul permanent)
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const newScore = parseInt(this.dataset.score);
                    scoreInput.value = newScore;
                    
                    // Forțează update-ul vizual
                    updateScoreVisual(newScore, false);
                    
                    // Elimină starea de hover
                    stars.forEach(s => s.classList.remove('hovered'));
                });
            });

            // 2. Logica la Hover (Pre-vizualizare)
            starRatingContainer.addEventListener('mouseover', function(e) {
                if (e.target.closest('.star')) {
                    const hoveredStar = e.target.closest('.star');
                    const hoverScore = parseInt(hoveredStar.dataset.score);
                    
                    // Actualizează vizualizarea steluțelor și a textului
                    updateScoreVisual(hoverScore, true);
                }
            });

            // 3. Logica la Mouse Out (Revine la scorul selectat)
            starRatingContainer.addEventListener('mouseleave', function() {
                resetVisualToSelected();
            });
        });
    </script>
{% endblock %}